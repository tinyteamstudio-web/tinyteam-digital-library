<script>
  // ✅ BuildFrame (Private) Web App endpoint
  const WEB_APP_URL =
    "https://script.google.com/macros/s/AKfycbxz45I7nQaPy_tL8542rTlEQA-RwAPCFTkINctXm6zpoUv48M8iYTHpkA_tb_XYmthrxg/exec";

  const form = document.getElementById("ttForm");
  const successBox = document.getElementById("successBox");
  const errorBox = document.getElementById("errorBox");
  const payBtn = document.getElementById("payBtn");

  // Auto-select package from URL: start.html?package=FAM / COMM / ADDON
  const urlPkg = new URLSearchParams(location.search).get("package");
  if (urlPkg && form) {
    const radio = form.querySelector(`input[type="radio"][value="${urlPkg}"]`);
    if (radio) radio.checked = true;
  }

  function injectDesignNotes() {
    const title = document.getElementById("libraryTitle").value.trim();
    const color = document.getElementById("primaryColor").value.trim();
    const themeEl = document.querySelector('input[name="tt_theme"]:checked');
    const theme = themeEl ? themeEl.value : "";

    const notesField = document.getElementById("notes");
    const existing = (notesField.value || "").trim();

    const block =
      "--- Design Preferences ---\n" +
      "Library Title: " + title + "\n" +
      "Theme: " + theme + "\n" +
      "Primary Color: " + color;

    notesField.value = existing ? (existing + "\n\n" + block) : block;
  }

  function isValid() {
    const name = document.getElementById("ownerName").value.trim();
    const email = document.getElementById("ownerEmail").value.trim();
    const pkg = form.querySelector('input[type="radio"][name="entry.1443621857"]:checked');

    const title = document.getElementById("libraryTitle").value.trim();
    const color = document.getElementById("primaryColor").value.trim();
    const theme = form.querySelector('input[name="tt_theme"]:checked');

    return !!(name && email && pkg && title && color && theme);
  }

  if (!form) {
    console.error("ttForm not found. Make sure your HTML has <form id='ttForm'>...");
  } else {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      successBox.style.display = "none";
      errorBox.style.display = "none";

      if (!isValid()) {
        errorBox.style.display = "block";
        return;
      }

      // Add design prefs into Notes BEFORE submit happens
      injectDesignNotes();

      // Collect values
      const selected = form.querySelector('input[type="radio"][name="entry.1443621857"]:checked');
      const pkgSelected = selected ? selected.value : (urlPkg || "FAM");

      const themeEl = document.querySelector('input[name="tt_theme"]:checked');
      const themeVal = themeEl ? themeEl.value : "";

      // Send to BuildFrame WebApp
      const fd = new FormData();
      fd.append("ownerName", document.getElementById("ownerName").value.trim());
      fd.append("ownerEmail", document.getElementById("ownerEmail").value.trim());
      fd.append("libraryTitle", document.getElementById("libraryTitle").value.trim());
      fd.append("theme", themeVal);
      fd.append("primaryColor", document.getElementById("primaryColor").value.trim());
      fd.append("package", pkgSelected);
      fd.append("notes", document.getElementById("notes").value.trim());
      fd.append("source", "tinyteamstudio.online/start.html");

      try {
        const res = await fetch(WEB_APP_URL, { method: "POST", body: fd });
        const raw = await res.text();
        console.log("WEBAPP RAW:", raw);

        const json = JSON.parse(raw);
        if (!json.ok) throw new Error(json.error || "WebApp returned ok:false");

      } catch (err) {
        console.error(err);
        errorBox.style.display = "block";
        errorBox.textContent = "Submit failed: " + err.message;
        return;
      }

      // ✅ Success UI only AFTER data is saved
      setTimeout(() => {
        successBox.style.display = "block";

        payBtn.href = `payment.html?package=${encodeURIComponent(pkgSelected)}`;
        payBtn.style.display = "inline-block";

        form.reset();

        // keep package selection if it came from URL
        if (urlPkg) {
          const radio2 = form.querySelector(`input[type="radio"][value="${urlPkg}"]`);
          if (radio2) radio2.checked = true;
          payBtn.href = `payment.html?package=${encodeURIComponent(urlPkg)}`;
        }
      }, 300);
    });
  }
</script>
