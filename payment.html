<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment — TinyTeam</title>
  <meta name="description" content="Payment instructions for approved TinyTeam Digital Library requests." />
  <link rel="stylesheet" href="assets/styles/main.css" />

  <style>
    .wrap { max-width: 1100px; margin: 0 auto; padding: 70px 20px; }
    .panel {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 18px;
      box-shadow: 0 14px 32px rgba(0,0,0,0.06);
      padding: 20px;
      margin-top: 16px;
    }
    .grid2 { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 18px; }
    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }

    .pay-title { display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .badge {
      background: rgba(24, 119, 242, 0.08);
      color: rgba(24, 119, 242, 0.95);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .qr-card {
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 16px;
      padding: 14px;
      background: #fafafa;
    }
    .qr-card h4 { margin: 0 0 10px; }
    .qr-card img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .qr-card a { font-weight: 800; }

    .muted { color: rgba(0,0,0,0.65); }
    .small { font-size: 0.95rem; }
    .hr { height:1px; background: rgba(0,0,0,0.08); margin: 16px 0; }

    .noteBox{
      border:1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 12px 14px;
      background: #f8fafc;
      margin-top: 10px;
    }
    .noteBox strong{ color:#111; }

    .oidRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .oidRow input{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.15);
      min-width: 260px;
      max-width: 420px;
      width: 100%;
      font-size: 14px;
    }
    .oidRow button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 0;
      background:#111827;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      font-size: 14px;
    }
    .oidHint{ margin:8px 0 0; font-size: 0.92rem; color: rgba(0,0,0,0.65); line-height:1.6; }

    /* ===== Option C: Modal (Embedded Google Form) ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalCard{
      width:min(980px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      background:#f8fafc;
    }
    .modalTop strong{ font-size: 0.98rem; }
    .modalClose{
      border:0;
      background:#111827;
      color:#fff;
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:800;
      font-size: 13px;
    }
    .modalBody{
      height: min(76vh, 720px);
      background:#fff;
    }
    .modalBody iframe{
      width:100%;
      height:100%;
      border:0;
    }

    @media (max-width: 980px) {
      .grid2 { grid-template-columns: 1fr; }
      .grid4 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px) {
      .grid4 { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<header>
  <div>
    <a href="index.html"><strong>TinyTeam Digital Library</strong></a>
    <nav>
      <a href="index.html#types">Packages</a>
      <a href="index.html#faq">FAQ</a>
      <a href="help/index.html">Help</a>
    </nav>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="pay-title">
      <h1 style="margin:0;">Payment</h1>
      <span class="badge" id="pkgBadge">Approved Request</span>
    </div>

    <p class="muted small" style="line-height:1.7;margin-top:10px;">
      <strong>Important:</strong> Please pay only after you receive an approval/confirmation message from us.
      This keeps your project verified and prevents mistaken payments.
    </p>

    <div class="panel grid2">
      <div>
        <h3 style="margin:0 0 8px;">Your Selected Package</h3>
        <p class="muted" style="margin:0 0 12px;line-height:1.7;" id="pkgText">
          Loading your package...
        </p>

        <div class="noteBox">
          <strong>Order ID is required</strong><br>
          <span class="muted small">
            You will receive your <strong>Order_ID</strong> in our approval/payment confirmation email.
            Use the same Order_ID when submitting your payment proof.
          </span>

          <div class="oidRow">
            <input id="orderIdInput" type="text"
              placeholder="Paste your Order_ID here (e.g., TT-ORD-2026-000001)"
              aria-label="Order ID"
              autocomplete="off" />
            <button id="copyBtn" type="button">Copy</button>
          </div>

          <p class="oidHint">
            If you don’t have your Order_ID yet, go back and submit your request first:
            <a href="start.html" style="font-weight:800;">Start Your Library</a>
          </p>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 8px;">Submit Payment Proof</h3>
        <p class="muted" style="margin:0 0 12px;line-height:1.7;">
          After payment, submit your proof so we can verify and move your project to <strong>Paid</strong>.
        </p>

        <!-- ===== Option B (Hidden Upload - No Google Form) ===== -->
        <div class="noteBox" id="uploadBox" style="margin-top:12px;">
          <strong>Upload Payment Proof (No Google Form)</strong><br>
          <span class="muted small">
            Upload your receipt/screenshot here. We’ll save it securely and match it to your Order_ID.
          </span>

          <div class="oidRow" style="margin-top:12px;">
            <input id="payerEmailInput" type="email" placeholder="Your Email (required)" autocomplete="email" />
          </div>

          <div class="oidRow">
            <input id="proofFile" type="file" accept="image/*,application/pdf" />
          </div>

          <p style="margin:10px 0 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn" id="uploadBtn" type="button" style="background:#111827;">Upload Proof Now</button>
            <span class="muted small" id="uploadStatus" style="display:none;"></span>
          </p>

          <p class="oidHint" style="margin-top:10px;">
            If upload doesn’t work (slow internet), use the secure upload options below.
          </p>
        </div>

        <!-- ===== Option A + Option C (Google Form) ===== -->
        <p style="margin:12px 0 0; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" id="proofBtn" href="#" target="_blank" rel="noopener">Secure Upload (Google Form)</a>
          <a class="btn" id="proofBtnPrefill" href="#" target="_blank" rel="noopener" style="background:#111827;">
            Secure Upload (Prefilled Order ID)
          </a>
          <button class="btn" id="openModalBtn" type="button" style="background:#0f172a;">
            Open Secure Upload Here
          </button>
        </p>

        <p class="muted small" style="margin-top:10px;line-height:1.7;">
          The secure upload uses Google’s file upload system. You can open it in a popup here (recommended),
          or in a new tab.
        </p>

        <p class="muted small" style="margin-top:12px;line-height:1.7;">
          Need help? Email:
          <a href="mailto:smallsteps@tinyteamstudio.online">smallsteps@tinyteamstudio.online</a>
        </p>

        <p class="muted small" style="margin-top:8px;line-height:1.7;">
          <strong>Member submission link:</strong> You will receive it by email after your payment is verified.
        </p>
      </div>

      <div>
        <h3 style="margin:0 0 8px;">PayPal (Recommended)</h3>
        <p class="muted small" style="margin:0 0 12px;">
          Scan the PayPal QR below or use the PayPal link.
        </p>

        <div id="paypalArea">
          <div class="qr-card" data-package="FAM">
            <h4>Family Library (FAM) — $48</h4>
            <img src="assets/qr/TinyTeam – Fam-qrcode.png" alt="PayPal FAM QR">
            <p style="margin:10px 0 0;">
              <a href="https://www.paypal.com/ncp/payment/T9KRP3UURZ63L" target="_blank" rel="noopener">Open PayPal Link</a>
            </p>
          </div>

          <div class="qr-card" data-package="COMM">
            <h4>Community Library (COMM) — $89</h4>
            <img src="assets/qr/TinyTeam – Com-qrcode.png" alt="PayPal COMM QR">
            <p style="margin:10px 0 0;">
              <a href="https://www.paypal.com/ncp/payment/K45JT94FYQD6C" target="_blank" rel="noopener">Open PayPal Link</a>
            </p>
          </div>

          <div class="qr-card" data-package="ADDON">
            <h4>Photo / Docs Add-On — $49</h4>
            <img src="assets/qr/TinyTeam – Pho-qrcode.png" alt="PayPal Add-On QR">
            <p style="margin:10px 0 0;">
              <a href="https://www.paypal.com/ncp/payment/45DWPFTGV72MY" target="_blank" rel="noopener">Open PayPal Link</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px;">Alternative Payment Options</h3>
      <p class="muted small" style="margin:0 0 14px;line-height:1.7;">
        If PayPal is not available for you, you may use the options below.
        Keep your receipt/screenshot and submit it via the options above.
      </p>

      <div class="grid4">
        <div class="qr-card">
          <h4>GCash</h4>
          <img src="assets/qr/gcash-qr.jpeg" alt="GCash QR">
        </div>
        <div class="qr-card">
          <h4>Maya</h4>
          <img src="assets/qr/maya-qr.jpeg" alt="Maya QR">
        </div>
        <div class="qr-card">
          <h4>GoTyme</h4>
          <img src="assets/qr/gotym-qr.jpeg" alt="GoTyme QR">
        </div>
        <div class="qr-card">
          <h4>PNB</h4>
          <img src="assets/qr/pnb-qr.jpeg" alt="PNB QR">
        </div>
      </div>
    </div>

    <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;">
      <a class="btn" href="index.html">Back to Home</a>
      <a class="btn" href="start.html">Start a New Request</a>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-contacts">
      <a href="mailto:chinveloso.consmaterials@gmail.com">chinveloso.consmaterials@gmail.com</a>
      <span class="dot">•</span>
      <a href="mailto:smallsteps@tinyteamstudio.online">smallsteps@tinyteamstudio.online</a>
    </div>
    <div class="footer-links">
      <a href="https://www.facebook.com/svpfunnels" target="_blank" rel="noopener">SVP Personal Facebook</a>
      <span class="dot">•</span>
      <a href="https://www.facebook.com/svpfunnels" target="_blank" rel="noopener">SVP Funnels Facebook Page</a>
      <span class="dot">•</span>
      <a href="https://www.facebook.com/profile.php?id=61585335397502" target="_blank" rel="noopener">TinyTeam Facebook Page</a>
    </div>
  </div>
</footer>

<!-- ===== Option C Modal (Embedded Google Form) ===== -->
<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true">
    <div class="modalTop">
      <strong>Secure Upload (Google Form)</strong>
      <button class="modalClose" id="modalCloseBtn" type="button">Close</button>
    </div>
    <div class="modalBody">
      <iframe id="formFrame" title="Secure Upload Form"></iframe>
    </div>
  </div>
</div>

<script>
  // ✅ Payment Proof Form base URL (Google Form)
  const PAYMENT_PROOF_FORM_URL =
    "https://docs.google.com/forms/d/e/1FAIpQLSdOa8FkqUfu8mXWuUgJtOHlUd7wu-DSnfMvpxbk0r8JkJD7GQ/viewform";

  // ✅ Web App URL (your NEW deployment)
  const WEBAPP_URL =
    "https://script.google.com/macros/s/AKfycbzrMDP8Z6jzy-3WJKSe7TLEMhRCLl9WIKvmNTLtjgR7MSm2vhKrDOtRRxmkynnu_HETSw/exec";

  // ✅ Prefill entry id for Order_ID in your Google Form
  const ORDER_ID_ENTRY_ID = "entry.1318981867";

  // ✅ Hidden upload safety limit (Base64 upload can fail if file is huge)
  const MAX_UPLOAD_BYTES = 8 * 1024 * 1024; // 8MB

  // Read URL params
  const params = new URLSearchParams(window.location.search);
  const pkg = (params.get("package") || "FAM").toUpperCase();

  // Show only the matching PayPal block
  document.querySelectorAll("#paypalArea .qr-card").forEach(card => {
    card.style.display = (card.dataset.package === pkg) ? "block" : "none";
  });

  // Update package text + badge
  const pkgText = document.getElementById("pkgText");
  const pkgBadge = document.getElementById("pkgBadge");

  const meta = {
    FAM:   { label: "Family Library (FAM)", price: "$48 one-time" },
    COMM:  { label: "Community Library (COMM)", price: "$89 one-time" },
    ADDON: { label: "Photo / Docs Add-On", price: "$49 one-time" }
  };

  const chosen = meta[pkg] || meta.FAM;
  if (pkgBadge) pkgBadge.textContent = chosen.label;
  if (pkgText) {
    pkgText.innerHTML = `
      <strong>${chosen.label}</strong><br>
      Amount: <strong>${chosen.price}</strong><br>
      <span class="muted small">After payment, submit proof so we can verify and continue building your library.</span>
    `;
  }

  // Build prefill URL (normal open)
  function buildPrefillUrl(orderId) {
    if (!ORDER_ID_ENTRY_ID || !orderId) return PAYMENT_PROOF_FORM_URL;
    const u = new URL(PAYMENT_PROOF_FORM_URL);
    u.searchParams.set(ORDER_ID_ENTRY_ID, orderId);
    u.searchParams.set("usp", "pp_url");
    return u.toString();
  }

  // Build prefill URL (embedded for modal)
  function buildEmbedPrefillUrl(orderId) {
    const u = new URL(buildPrefillUrl(orderId));
    u.searchParams.set("embedded", "true");
    return u.toString();
  }

  // Order ID input
  const orderIdInput = document.getElementById("orderIdInput");
  const oidFromUrl = (params.get("order_id") || "").trim();
  if (orderIdInput && oidFromUrl) orderIdInput.value = oidFromUrl;

  // Copy helper
  const copyBtn = document.getElementById("copyBtn");
  if (copyBtn && orderIdInput) {
    copyBtn.addEventListener("click", async () => {
      const val = (orderIdInput.value || "").trim();
      if (!val) return;
      try { await navigator.clipboard.writeText(val); copyBtn.textContent = "Copied ✓"; }
      catch(e){ copyBtn.textContent = "Copy"; }
      setTimeout(() => copyBtn.textContent = "Copy", 1200);
    });
  }

  // Option A buttons (open new tab)
  const proofBtn = document.getElementById("proofBtn");
  const proofBtnPrefill = document.getElementById("proofBtnPrefill");

  if (proofBtn) proofBtn.href = PAYMENT_PROOF_FORM_URL;

  function refreshPrefillButtons() {
    const oid = orderIdInput ? (orderIdInput.value || "").trim() : "";
    if (proofBtnPrefill) proofBtnPrefill.href = buildPrefillUrl(oid);
  }
  refreshPrefillButtons();

  if (orderIdInput) {
    orderIdInput.addEventListener("input", refreshPrefillButtons);
  }

  // Option C: modal open (embedded form)
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const openModalBtn = document.getElementById("openModalBtn");
  const formFrame = document.getElementById("formFrame");

  function openModalWithUrl(url){
    if (!formFrame || !modalBackdrop) return;
    formFrame.src = url;
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    if (!modalBackdrop || !formFrame) return;
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden", "true");
    formFrame.src = "about:blank";
    document.body.style.overflow = "";
  }

  if (openModalBtn) {
    openModalBtn.addEventListener("click", () => {
      const oid = orderIdInput ? (orderIdInput.value || "").trim() : "";
      openModalWithUrl(buildEmbedPrefillUrl(oid));
    });
  }
  if (modalCloseBtn) modalCloseBtn.addEventListener("click", closeModal);
  if (modalBackdrop) {
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
  }
  // ESC closes modal
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  // ===== Option B: Hidden upload =====
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const payerEmailInput = document.getElementById("payerEmailInput");
  const proofFile = document.getElementById("proofFile");

  function showUploadStatus(msg) {
    if (!uploadStatus) return;
    uploadStatus.style.display = "inline";
    uploadStatus.textContent = msg;
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result || "";
        const base64 = String(result).split(",")[1] || "";
        resolve(base64);
      };
      reader.onerror = () => reject(reader.error || new Error("File read failed"));
      reader.readAsDataURL(file);
    });
  }

  if (uploadBtn) {
    uploadBtn.addEventListener("click", async () => {
      const orderId = orderIdInput ? (orderIdInput.value || "").trim() : "";
      const payerEmail = payerEmailInput ? (payerEmailInput.value || "").trim() : "";
      const file = (proofFile && proofFile.files && proofFile.files[0]) ? proofFile.files[0] : null;

      if (!payerEmail) { showUploadStatus("Please enter your email."); return; }
      if (!orderId) { showUploadStatus("Please enter your Order_ID."); return; }
      if (!file) { showUploadStatus("Please choose an image/PDF file."); return; }

      if (file.size > MAX_UPLOAD_BYTES) {
        showUploadStatus("File too large. Please upload a smaller image (recommended under 8MB), or use the Secure Google Form option.");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";
      showUploadStatus("Uploading... please wait.");

      try {
        const base64 = await fileToBase64(file);

        const body = new URLSearchParams();
        body.set("action", "PAYMENT_PROOF_UPLOAD");
        body.set("orderId", orderId);
        body.set("payerEmail", payerEmail);
        body.set("package", pkg);
        body.set("fileName", file.name);
        body.set("mimeType", file.type || "application/octet-stream");
        body.set("fileBase64", base64);

        const res = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: body.toString()
        });

        const json = await res.json();
        if (!json || !json.ok) throw new Error((json && json.error) ? json.error : "Upload failed.");

        showUploadStatus("✅ Uploaded! We received your proof. Thank you.");
        uploadBtn.textContent = "Uploaded ✓";

      } catch (err) {
        showUploadStatus("Error: " + (err && err.message ? err.message : String(err)));
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload Proof Now";
      }
    });
  }
</script>

</body>
</html>
